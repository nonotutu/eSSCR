= render "list"

-#

  - if (params[:tri_ordre].present?)
    - session[:tri_ordre] = params[:tri_ordre]

  - if (params[:tri_annee].present?)
    - session[:tri_annee] = params[:tri_annee]

  .title_active_element_1
    Events list

  - liste_ordre = []
  - liste_ordre << { :value => '1', :name => 'croissant' }
  - liste_ordre << { :value => '2', :name => 'décroissant' }
  - liste_ordre << { :value => '3', :name => 'alphabétique' }
  - liste_ordre << { :value => '4', :name => 'désalphabétique' }

  - liste_annee = []
  - liste_annee << { :value => 'all', :name => 'Toutes' }
  - liste_annee << { :value => '2010', :name => '2010' }
  - liste_annee << { :value => '2011', :name => '2011' }
  - liste_annee << { :value => '2012', :name => '2012' }

  %form{:action => '', :method => :get}
    Order by : 
    %select{:name => 'tri_ordre'}
      = liste_ordre.each do |item|
        - selected = ( item[:value] == session[:tri_ordre] ? 'selected' : nil )
        %option{ :value => item[:value], :selected => selected }= item[:name]
    %br/
    Year : 
    %select{:name => 'tri_annee'}
      = liste_annee.each do |item|
        - selected = ( item[:value] == session[:tri_annee] ? 'selected' : nil )
        %option{ :value => item[:value], :selected => selected }= item[:name]
    %input{:type => :submit}

  - events = Event.all

  - if ( session[:tri_ordre] == '2' )
    - events.reverse!
  
  - if ( session[:tri_ordre] == '3' )
    - events = events.order('name')

  - if ( session[:tri_ordre] == '4' )
    - events = events.order('name').reverse

  - if ( session[:tri_annee].present? )
    - unless ( session[:tri_annee] == 'all' )
      - events = Event.joins(:services).where("SUBSTR(starts_at,1,4) = ?", session[:tri_annee])

  -#
    .liste
      %ul
        - Event.all(:include => :services).each do |event|
          %li
            = event.name
            %ul
              - event.services.each do |service|
                %li
                  = service.starts_at.to_s(:cust_short)
                  →
                  = service.relative_ends_at
      
  .liste
    %ul
      - events.each do |event|
        %li
          - evt = event.category.short_name + " - " + event.name
          = link_to evt, event_path(event)

  %hr
  = link_to 'New event', new_event_path
